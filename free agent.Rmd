---
title: "final project"
author: "matt c"
date: "2025-11-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(factoextra)
library(baseballr)
library(caret)
library(plotly)
```

Our initial API calls (to the MLBStats API through the baseballr wrapper) to get the list of current free agents, and then full 2025 season stats for all players.
```{r}
current_free_agents = mlb_people_free_agents(season = 2025)
hitting_stats_2025 = mlb_stats(stat_type = 'season', player_pool = 'all', stat_group = 'hitting', season = 2025)
pitching_stats_2025 = mlb_stats(stat_type = 'season', player_pool = 'all', stat_group = 'pitching', season = 2025)
```

Querying the Statcast database with the baseballr wrapper to get advanced statistics for our players of interest.
```{r}
statcast_hit_leaders = statcast_leaderboards(leaderboard = "expected_statistics", year = 2025, min_pa = 50)
statcast_pitch_leaders = statcast_leaderboards(leaderboard = "expected_statistics", year = 2025, min_pitches = 250, player_type = "pitcher")
```

Cleaning the data. The API returns a bunch of extraneous (for my purposes at least) information, so we want to get rid of that and split our free agent table into two in order to join to the stats data. We also need to filter out players who have already signed - targeting them in free agency is no longer an option!
```{r}
pitching_free_agents = current_free_agents %>% filter(position_type=='Pitcher') %>% filter(new_team_link=='/api/v1/teams/null') %>% select(player_id)
hitting_free_agents = current_free_agents %>% filter(position_type!='Pitcher') %>% filter(new_team_link=='/api/v1/teams/null')  %>% select(player_id)

pitching_free_agents_stats = left_join(pitching_free_agents, pitching_stats_2025, join_by('player_id'=='player_id'))
hitting_free_agents_stats = left_join(hitting_free_agents, hitting_stats_2025, join_by('player_id'=='player_id'))

pitching_free_agents_stats = left_join(pitching_free_agents_stats, statcast_pitch_leaders, join_by('player_id'=='player_id'))
hitting_free_agents_stats = left_join(hitting_free_agents_stats, statcast_hit_leaders, join_by('player_id'=='player_id'))
```

It also makes sense to get rid of players who didn't hit a certain number of plate appearances or pitching appearances - while these guys may still hold value, it won't really be found in this data. Then, I'm keeping the stats we really care about (hits, avg, etc), and dropping a lot of the API specific information - we don't need it anymore.
```{r}
hitting_free_agents_stats = hitting_free_agents_stats %>% filter(plate_appearances >= 50) %>% select(player_id, player_full_name, position_abbreviation, age, ground_outs, air_outs, runs, doubles, triples, home_runs, strike_outs, base_on_balls, intentional_walks, hits, avg, at_bats, obp, slg.y, ops, stolen_bases, stolen_base_percentage, ground_into_double_play, number_of_pitches, plate_appearances, total_bases, rbi, babip, ground_outs_to_airouts, at_bats_per_home_run, est_ba, est_ba_minus_ba_diff, est_slg, est_slg_minus_slg_diff, woba, est_woba, est_woba_minus_woba_diff) %>% drop_na()

pitching_free_agents_stats = pitching_free_agents_stats %>% filter(games_played > 15) %>% select(player_id, player_full_name, position_abbreviation, age, ground_outs, air_outs, runs, doubles, triples, home_runs, strike_outs, base_on_balls, intentional_walks, hits, avg, at_bats, obp, slg.y, ops, stolen_bases, stolen_base_percentage, ground_into_double_play, number_of_pitches, era.y, xera, era_minus_xera_diff, innings_pitched, wins, losses, earned_runs, whip, saves, save_opportunities, holds, strikes, strike_percentage, strikeout_walk_ratio, strikeouts_per9inn, wild_pitches, total_bases, pitches_per_inning, walks_per9inn, hits_per9inn, home_runs_per9, bip, est_ba, est_ba_minus_ba_diff, est_slg, est_slg_minus_slg_diff, woba, est_woba, est_woba_minus_woba_diff) %>% drop_na()
```

Now for some basic plots and data exploration. 
```{r}

hr_avg = hitting_free_agents_stats %>% plot_ly(type = 'scatter', x= ~home_runs, y= ~as.numeric(avg), marker = list(size = ~plate_appearances, sizeref = 5, sizemode = 'area'), text = ~player_full_name, hovertemplate = paste('<b>%{text}</b>
      %{yaxis.title.text}: %{y},
      %{xaxis.title.text}: %{x}'))
hr_avg
```

k-means clusters of batting average and expected batting average
```{r}
hitting_free_agents_stats$avg = as.numeric(hitting_free_agents_stats$avg)
for_k_means = hitting_free_agents_stats %>% select(avg, est_ba, est_ba_minus_ba_diff)


fviz_nbclust(for_k_means, kmeans, method = "wss", k.max = 25)
km = kmeans(for_k_means, 7)

hitting_free_agents_stats$xba_cluster = km$cluster
```

graphing our kmean clusters and batting average
```{r}
ggplot(hitting_free_agents_stats) + geom_point(aes(avg, est_ba,color=as.factor(xba_cluster), size=plate_appearances))
```

```{r}
for_k_means_2 = hitting_free_agents_stats %>% select(slg.y, est_slg, est_slg_minus_slg_diff)


fviz_nbclust(for_k_means_2, kmeans, method = "wss", k.max = 25)
km2 = kmeans(for_k_means_2, 9)

hitting_free_agents_stats$xslg_cluster = km2$cluster

```

```{r}
ggplot(hitting_free_agents_stats) + geom_point(aes(slg.y, est_slg,color=as.factor(xslg_cluster), size=plate_appearances))
```

```{r}
for_k_means_3 = hitting_free_agents_stats %>% select(est_ba_minus_ba_diff, est_slg_minus_slg_diff, est_woba_minus_woba_diff)

fviz_nbclust(for_k_means_3, kmeans, method = "wss", k.max = 25)
km3 = kmeans(for_k_means_3, 5)
hitting_free_agents_stats$diff_cluster = km3$cluster
```

```{r}
ggplot(hitting_free_agents_stats) + geom_point(aes(est_ba_minus_ba_diff, est_slg_minus_slg_diff,color=as.factor(diff_cluster), size=plate_appearances))
```


Now for pitchers!
```{r}
for_k_means_4 = pitching_free_agents_stats %>% select(era.y, xera, era_minus_xera_diff) %>% drop_na()

fviz_nbclust(for_k_means_4, kmeans, method = "wss", k.max = 25)
km4 = kmeans(for_k_means_4, 8)
pitching_free_agents_stats$era_cluster = km4$cluster
```

```{r}
ggplot(pitching_free_agents_stats) + geom_point(aes(era.y, xera,color=as.factor(era_cluster), size=as.numeric(innings_pitched)))
```

```{r}
pitching_free_agents_stats$avg = as.numeric(pitching_free_agents_stats$avg)
for_k_means_5 = pitching_free_agents_stats %>% select(avg, est_ba, est_ba_minus_ba_diff)


fviz_nbclust(for_k_means_5, kmeans, method = "wss", k.max = 25)
km5 = kmeans(for_k_means_5, 10)

pitching_free_agents_stats$xba_cluster = km5$cluster
```

```{r}
ggplot(pitching_free_agents_stats) + geom_point(aes(avg, est_ba,color=as.factor(xba_cluster), size=as.numeric(innings_pitched)))
```

```{r}
for_k_means_6 = pitching_free_agents_stats %>% select(slg.y, est_slg, est_slg_minus_slg_diff)


fviz_nbclust(for_k_means_6, kmeans, method = "wss", k.max = 25)
km6 = kmeans(for_k_means_6, 8)

pitching_free_agents_stats$xslg_cluster = km6$cluster
```

```{r}
ggplot(pitching_free_agents_stats) + geom_point(aes(slg.y, est_slg,color=as.factor(xslg_cluster), size=as.numeric(innings_pitched)))
```